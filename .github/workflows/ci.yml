name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test-server:
    name: Server Tests & Coverage
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install server dependencies
        working-directory: ./server
        run: npm ci

      - name: Setup MongoDB Memory Server
        working-directory: ./server
        run: |
          # Pre-download MongoDB binaries to avoid timeout issues
          npx mongodb-memory-server-core install || echo "MongoDB binary download skipped"
        continue-on-error: true

      - name: Run server tests with coverage
        working-directory: ./server
        continue-on-error: true
        id: server-tests
        run: npm run test:ci

      - name: Debug - List coverage directory
        working-directory: ./server
        if: always()
        run: |
          echo "Checking coverage directory..."
          ls -la coverage/ 2>&1 || echo "Coverage directory not found"
          if [ -f "./coverage/coverage-summary.json" ]; then
            echo "✅ Coverage summary file exists"
            cat ./coverage/coverage-summary.json
          else
            echo "❌ Coverage summary file not found"
          fi
          
      - name: Check server coverage threshold
        working-directory: ./server
        if: steps.server-tests.outcome == 'success'
        run: |
          if [ ! -f "./coverage/coverage-summary.json" ]; then
            echo "❌ Coverage file not found. Tests may have failed or coverage was not generated."
            exit 1
          fi
          COVERAGE=$(node -e "const coverage = require('./coverage/coverage-summary.json'); const total = coverage.total; const avg = (total.lines.pct + total.statements.pct + total.functions.pct + total.branches.pct) / 4; console.log(avg.toFixed(2));")
          echo "Server coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 0" | bc -l) )); then
            echo "❌ Coverage $COVERAGE% is below 0% threshold"
            exit 1
          fi
          echo "✅ Coverage $COVERAGE% meets threshold"

      - name: Upload server coverage
        uses: actions/upload-artifact@v4
        with:
          name: server-coverage
          path: server/coverage
          retention-days: 30

  test-client:
    name: Client Tests & Coverage
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install client dependencies
        working-directory: ./client
        run: npm ci

      - name: Run client tests with coverage
        working-directory: ./client
        continue-on-error: true
        id: client-tests
        run: npm run test:coverage

      - name: Debug - List coverage directory
        working-directory: ./client
        if: always()
        run: |
          echo "Checking coverage directory..."
          ls -la coverage/ 2>&1 || echo "Coverage directory not found"
          if [ -f "./coverage/coverage-summary.json" ]; then
            echo "✅ Coverage summary file exists"
            cat ./coverage/coverage-summary.json
          else
            echo "❌ Coverage summary file not found"
          fi
          
      - name: Check client coverage threshold
        working-directory: ./client
        if: steps.client-tests.outcome == 'success'
        run: |
          if [ ! -f "./coverage/coverage-summary.json" ]; then
            echo "❌ Coverage file not found. Tests may have failed or coverage was not generated."
            exit 1
          fi
          COVERAGE=$(node -e "const coverage = require('./coverage/coverage-summary.json'); const total = coverage.total; const avg = (total.lines.pct + total.statements.pct + total.functions.pct + total.branches.pct) / 4; console.log(avg.toFixed(2));")
          echo "Client coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 0" | bc -l) )); then
            echo "❌ Coverage $COVERAGE% is below 0% threshold"
            exit 1
          fi
          echo "✅ Coverage $COVERAGE% meets threshold"

      - name: Upload client coverage
        uses: actions/upload-artifact@v4
        with:
          name: client-coverage
          path: client/coverage
          retention-days: 30

  security-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}

      - name: Audit server dependencies
        working-directory: ./server
        run: |
          npm audit --audit-level=high || echo "::warning::Server has high/critical vulnerabilities"
          npm audit --json > audit-server.json || true

      - name: Audit client dependencies
        working-directory: ./client
        run: |
          npm audit --audit-level=high || echo "::warning::Client has high/critical vulnerabilities"
          npm audit --json > audit-client.json || true

      - name: Upload audit reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-reports
          path: |
            server/audit-server.json
            client/audit-client.json
          retention-days: 30

  build:
    name: Build Validation
    runs-on: ubuntu-latest
    needs: [test-server, test-client]

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install server dependencies
        working-directory: ./server
        run: npm ci

      - name: Install client dependencies
        working-directory: ./client
        run: npm ci

      - name: Build client (Next.js)
        working-directory: ./client
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://0.0.0.0:5000/api/v1
          NEXT_PUBLIC_FIREBASE_API_KEY: AIzaSyDfpTA2iVzhrtDkBXLUyfyh5V73dE88kOA5ni7a
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: shopmate-4f95e.firebaseapp.com
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: shopmate-4f95e
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: shopmate-4f95e.appspot.com
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: 287739665551
          NEXT_PUBLIC_FIREBASE_APP_ID: 1:287739665551:web:d8fe522668351586794611
          NEXT_PUBLIC_RAZORPAY_KEY_ID: rzp_test_zH4v3Xb2X8X8X8
          

      - name: Verify server TypeScript compilation
        working-directory: ./server
        run: npx tsc --noEmit

  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    needs: [build]

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          cd client && npm ci
          cd ../server && npm ci

      - name: Build Next.js app
        working-directory: ./client
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://0.0.0.0:5000/api/v1
          NEXT_PUBLIC_FIREBASE_API_KEY: AIzaSyDfpTA2iVzhrtDkBXLUyfyh5V73dE88kOA5ni7a
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: shopmate-4f95e.firebaseapp.com
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: shopmate-4f95e
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: shopmate-4f95e.appspot.com
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: 287739665551
          NEXT_PUBLIC_FIREBASE_APP_ID: 1:287739665551:web:d8fe522668351586794611
          NEXT_PUBLIC_RAZORPAY_KEY_ID: rzp_test_zH4v3Xb2X8X8X8

      - name: Start Next.js server
        working-directory: ./client
        run: npm start &
        env:
          NEXT_PUBLIC_API_URL: http://0.0.0.0:5000/api/v1
          NEXT_PUBLIC_FIREBASE_API_KEY: AIzaSyDfpTA2iVzhrtDkBXLUyfyh5V73dE88kOA5ni7a
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: shopmate-4f95e.firebaseapp.com
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: shopmate-4f95e
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: shopmate-4f95e.appspot.com
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: 287739665551
          NEXT_PUBLIC_FIREBASE_APP_ID: 1:287739665551:web:d8fe522668351586794611
          NEXT_PUBLIC_RAZORPAY_KEY_ID: rzp_test_zH4v3Xb2X8X8X8

      - name: Wait for server to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://0.0.0.0:3000; do sleep 2; done'

      - name: Run Lighthouse CI
        run: npx @lhci/cli@0.13.x autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: .lighthouseci
          retention-days: 30

  publish-images:
    name: Publish to Docker Hub
    runs-on: ubuntu-latest
    needs: [build]
    environment: Configure docker
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: aipowereddevteam
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Server
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: |
            aipowereddevteam/ecombrand-server:latest
            aipowereddevteam/ecombrand-server:${{ github.sha }}

      - name: Build and push Client
        uses: docker/build-push-action@v5
        with:
          context: ./client
          build-args: |
            NEXT_PUBLIC_API_URL=http://0.0.0.0:5000/api/v1
          push: true
          tags: |
            aipowereddevteam/ecombrand-client:latest
            aipowereddevteam/ecombrand-client:${{ github.sha }}
